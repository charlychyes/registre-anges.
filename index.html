<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE UNIT - PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #0a3d62; --accent: #87CEEB; --success: #27ae60; --danger: #c0392b; --bg: #f4f7f6; --text: #333; --card: white; }
        .dark-mode { --primary: #121212; --accent: #87CEEB; --bg: #1e1e1e; --text: #f4f7f6; --card: #2d2d2d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        #side-menu { position: fixed; left: -250px; top: 0; width: 250px; height: 100%; background: var(--primary); color: white; transition: 0.3s; z-index: 2000; padding-top: 60px; }
        #side-menu div { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); display:flex; align-items:center; justify-content:center; z-index:3000; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 85%; max-width: 400px; text-align:center; color: #0a3d62; }
        .container { max-width: 900px; margin: auto; background: var(--card); min-height: 100vh; }
        .header { background: var(--primary); color: white; padding: 20px; display: flex; align-items: center; border-bottom: 5px solid var(--accent); }
        .chart-container { width: 180px; margin: 20px auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); background: var(--card); }
        .stat-item { padding: 15px; border: 0.5px solid rgba(0,0,0,0.05); text-align: center; }
        .stat-item b { display: block; font-size: 1.1rem; color: var(--accent); }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(0,0,0,0.05); padding: 12px; font-size: 0.75rem; color: var(--text); }
        td { padding: 12px 8px; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: center; font-size: 0.8rem; }
        .editable { cursor: pointer; border-bottom: 1px dashed var(--accent); font-weight: bold; }
        .btn { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; color: white; font-size: 0.7rem; }
        .paid { background: var(--success); } .unpaid { background: var(--danger); }
        .pdf-btn { background: var(--accent); color: var(--primary); margin-top: 2px; }
        .mail-btn { background: #576571; color: white; margin-top: 2px; }
        .admin-area { display: none; padding: 20px; background: rgba(135, 206, 235, 0.1); border-top: 2px solid var(--accent); }
        input, select { padding: 12px; margin: 8px 0; width: 90%; border: 1px solid #ccc; border-radius: 8px; background: var(--card); color: var(--text); }
    </style>
</head>
<body>

<div id="side-menu">
    <div onclick="toggleDarkMode()">ðŸŒ“ Mode Sombre / Clair</div>
    <div onclick="showEmails()">ðŸ“§ Liste des E-mails (Admin)</div>
    <div onclick="closeMenu()">âœ– Fermer le Menu</div>
</div>

<div id="login-overlay">
    <div class="login-box">
        <h2>ONE UNIT</h2>
        <p>Entrez votre e-mail pour accÃ©der au registre.</p>
        <input type="email" id="user-email" placeholder="votre@email.com">
        <button onclick="saveEmail()" style="background:var(--primary); color:white; border:none; padding:15px; width:100%; border-radius:8px; margin-top:10px; font-weight:bold;">ACCÃ‰DER</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <span onclick="openMenu()" style="font-size:25px; cursor:pointer; margin-right:15px; color:var(--accent);">â˜°</span>
        <div style="flex-grow:1">
            <h1 style="margin:0; font-size: 1.4rem;">ONE UNIT</h1>
            <small id="live-clock" style="color:var(--accent);"></small>
        </div>
        <button onclick="askAccess()" id="lock-btn" style="background:none; border:1px solid var(--accent); color:var(--accent); padding:6px; border-radius:5px; font-size: 0.7rem;">ADMIN</button>
    </div>

    <div class="chart-container"><canvas id="myChart"></canvas></div>

    <div class="stats-grid">
        <div class="stat-item">USD<br><b id="tUSD">0</b></div>
        <div class="stat-item">CDF<br><b id="tCDF">0</b></div>
        <div class="stat-item">EUR<br><b id="tEUR">0</b></div>
        <div class="stat-item">BIF<br><b id="tBIF">0</b></div>
    </div>

    <table>
        <thead><tr><th>MEMBRE / DATE</th><th>MONTANT</th><th>ACTIONS</th></tr></thead>
        <tbody id="list"></tbody>
    </table>

    <div id="admin" class="admin-area">
        <h3>AJOUTER MEMBRE</h3>
        <input type="text" id="name" placeholder="Nom complet">
        <p style="font-size:0.7rem; color:gray;">(Optionnel lors de l'inscription initiale :)</p>
        <input type="number" id="amt" placeholder="Montant">
        <select id="cur"><option value="USD">USD</option><option value="CDF">CDF</option><option value="EUR">EUR</option><option value="BIF">BIF</option></select>
        <button onclick="add()" style="background:var(--primary); color:white; padding:15px; width:100%; border:none; border-radius:8px; font-weight:bold;">ENREGISTRER</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB78cC9gnYCgPjd9ikZjboHqWq86-j-7YI",
        authDomain: "oneunit-dfa62.firebaseapp.com",
        databaseURL: "https://oneunit-dfa62-default-rtdb.firebaseio.com",
        projectId: "oneunit-dfa62",
        storageBucket: "oneunit-dfa62.firebasestorage.app",
        messagingSenderId: "837193571803", appId: "1:837193571803:web:b921421a5765c363943340"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const membersRef = db.ref('members');
    const logsRef = db.ref('logs');
    let isAdmin = false; let myChart;

    if(localStorage.getItem('oneUnitEmail')) document.getElementById('login-overlay').style.display = 'none';

    function openMenu() { document.getElementById('side-menu').style.left = '0'; }
    function closeMenu() { document.getElementById('side-menu').style.left = '-250px'; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); closeMenu(); }

    function saveEmail() {
        const email = document.getElementById('user-email').value;
        if(email.includes('@')) {
            localStorage.setItem('oneUnitEmail', email);
            logsRef.push({ email: email, date: new Date().toLocaleString() });
            document.getElementById('login-overlay').style.display = 'none';
        }
    }

    function askAccess() {
        if(prompt("Code Admin :") === "05102005") {
            isAdmin = true;
            document.getElementById('admin').style.display = 'block';
            document.getElementById('lock-btn').innerText = "ADMIN ON";
            renderList();
        }
    }

    function add() {
        const n = document.getElementById('name').value;
        const a = parseFloat(document.getElementById('amt').value) || 0;
        if(n) {
            membersRef.push({ 
                name: n, 
                amount: a, 
                currency: document.getElementById('cur').value, 
                paid: a > 0 ? true : false, 
                date: new Date().toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'}) 
            });
            document.getElementById('name').value = ""; document.getElementById('amt').value = "";
        }
    }

    // FONCTION POUR MODIFIER MONTANT/DEVISE
    function editMember(key, field, currentVal) {
        if(!isAdmin) return;
        let newVal;
        if(field === 'currency') {
            newVal = prompt("Nouvelle devise (USD, CDF, EUR, BIF) :", currentVal).toUpperCase();
            if(!['USD','CDF','EUR','BIF'].includes(newVal)) return;
        } else {
            newVal = parseFloat(prompt("Nouveau montant :", currentVal));
            if(isNaN(newVal)) return;
        }
        membersRef.child(key).update({ [field]: newVal });
    }

    function removeMember(key) { if(confirm("Supprimer ?")) membersRef.child(key).remove(); }
    function toggle(key, status) { if(isAdmin) membersRef.child(key).update({ paid: !status }); }

    function generatePDF(name, amount, curr, date) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setDrawColor(135, 206, 235); doc.setLineWidth(2); doc.rect(10, 10, 190, 80);
        doc.setFontSize(22); doc.setTextColor(10, 61, 98); doc.text("ONE UNIT", 105, 30, { align: "center" });
        doc.setFontSize(12); doc.setTextColor(0,0,0);
        doc.text(`Membre : ${name.toUpperCase()}`, 20, 50);
        doc.text(`Montant : ${amount} ${curr}`, 20, 60);
        doc.text(`Date : ${date || '---'}`, 20, 70);
        doc.save(`Recu_${name}.pdf`);
    }

    function sendEmail(name, amount, curr, date) {
        const email = prompt("Adresse e-mail du membre :");
        if(email) {
            const sub = encodeURIComponent(`Facture ONE UNIT - ${name}`);
            const body = encodeURIComponent(`Bonjour ${name},\n\nVotre paiement de ${amount} ${curr} a Ã©tÃ© validÃ© le ${date}.\n\nMerci,\nL'Administration ONE UNIT.`);
            window.location.href = `mailto:${email}?subject=${sub}&body=${body}`;
        }
    }

    let currentData = {};
    membersRef.on('value', (snap) => { currentData = snap.val() || {}; renderList(); });

    function renderList() {
        const list = document.getElementById('list');
        list.innerHTML = "";
        let t = {USD:0, CDF:0, EUR:0, BIF:0}, pCount=0, uCount=0;
        Object.keys(currentData).forEach(key => {
            const m = currentData[key];
            if(m.paid) { t[m.currency] += m.amount; pCount++; } else { uCount++; }
            list.innerHTML += `<tr>
                <td style="text-align:left">
                    ${isAdmin ? `<button onclick="removeMember('${key}')" style="color:red; border:none; background:none; font-size:0.6rem; cursor:pointer;">DELETE</button>` : ''}
                    <b>${m.name.toUpperCase()}</b><br><small>${m.date || '---'}</small>
                </td>
                <td>
                    <span class="${isAdmin ? 'editable' : ''}" onclick="editMember('${key}', 'amount', ${m.amount})">${m.amount}</span> 
                    <span class="${isAdmin ? 'editable' : ''}" onclick="editMember('${key}', 'currency', '${m.currency}')">${m.currency}</span>
                </td>
                <td>
                    <button onclick="toggle('${key}', ${m.paid})" class="btn ${m.paid ? 'paid':'unpaid'}">${m.paid ? 'PAYÃ‰':'Ã€ PAYER'}</button>
                    ${m.paid ? `<br><button onclick="generatePDF('${m.name}', ${m.amount}, '${m.currency}', '${m.date}')" class="btn pdf-btn">PDF</button>
                    <button onclick="sendEmail('${m.name}', ${m.amount}, '${m.currency}', '${m.date}')" class="btn mail-btn">MAIL</button>` : ''}
                </td>
            </tr>`;
        });
        ['USD','CDF','EUR','BIF'].forEach(c => document.getElementById('t'+c).innerText = t[c]);
        updateChart(pCount, uCount);
    }

    function updateChart(p, u) {
        const ctx = document.getElementById('myChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['PayÃ©s', 'Ã€ Payer'], datasets: [{ data: [p, u], backgroundColor: ['#27ae60', '#c0392b'], borderWidth:0 }] }, options: { plugins: { legend: { display: false } }, cutout: '80%' } });
    }
    function updateClock() { document.getElementById('live-clock').innerText = new Date().toLocaleString('fr-FR'); }
    setInterval(updateClock, 1000);
</script>
</body>
</html>
